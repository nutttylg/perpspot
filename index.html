<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Spot vs Perpetual Futures</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier Prime', 'Courier New', monospace;
            background: #000;
            color: #fff;
            padding: 10px;
            min-height: 100vh;
            font-size: 12px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        h1 {
            font-size: 16px;
            font-weight: normal;
            margin-bottom: 5px;
        }

        .status {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 11px;
            flex-wrap: wrap;
        }

        .status-item {
            background: #111;
            padding: 5px 10px;
            border: 1px solid #333;
        }

        .status-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-dot.connected {
            background: #00ff00;
        }

        .status-dot.disconnected {
            background: #ff0000;
        }

        .tables-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .binance-section {
            display: contents;
        }

        .bybit-section {
            display: contents;
        }

        @media (max-width: 1400px) {
            .tables-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 968px) {
            .tables-container {
                grid-template-columns: 1fr;
            }
        }

        .table-wrapper {
            background: #111;
            border: 1px solid #333;
            padding: 10px;
        }

        .alert-log-wrapper {
            background: #111;
            border: 1px solid #333;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .alert-log-body {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .alert-log-body::-webkit-scrollbar {
            width: 8px;
        }

        .alert-log-body::-webkit-scrollbar-track {
            background: #000;
        }

        .alert-log-body::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        .alert-log-body::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .alert-log-entry {
            padding: 6px;
            border-bottom: 1px solid #222;
            font-size: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-log-entry.mega {
            background: #1a0a0a;
            border-left: 3px solid #ef4444;
        }

        .alert-log-entry.standard {
            border-left: 3px solid #4ade80;
        }

        .alert-log-time {
            color: #666;
            font-size: 9px;
        }

        .alert-log-symbol {
            color: #ddd;
            font-weight: bold;
        }

        .alert-log-percent {
            color: #4ade80;
        }

        .alert-log-entry.mega .alert-log-percent {
            color: #ef4444;
        }

        .table-header {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }

        .table-header.positive {
            color: #4ade80;
        }

        .table-header.negative {
            color: #ef4444;
        }

        table {
            border-collapse: collapse;
            table-layout: fixed;
        }

        thead th {
            text-align: left;
            padding: 5px;
            font-weight: bold;
            border-bottom: 1px solid #333;
            font-size: 11px;
            color: #888;
        }

        thead th:nth-child(1) {
            width: 150px;
        }

        thead th:nth-child(2) {
            width: 90px;
        }

        thead th:nth-child(3) {
            width: 100px;
        }

        tbody tr {
            transition: background 0.1s;
        }

        tbody tr:hover {
            background: #1a1a1a;
        }

        tbody td {
            padding: 4px 5px;
            border-bottom: 1px solid #222;
            font-size: 11px;
        }

        .symbol {
            font-weight: normal;
            color: #ddd;
        }

        .spread-positive {
            color: #4ade80;
            text-align: right;
        }

        .spread-negative {
            color: #ef4444;
            text-align: right;
        }

        .delta {
            text-align: right;
            color: #999;
            font-size: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 11px;
            color: #666;
        }

        footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #333;
            font-size: 10px;
            color: #666;
        }

        .alert-status {
            margin-top: 10px;
            padding: 8px;
            background: #1a1a1a;
            border: 1px solid #333;
            display: inline-block;
        }

        .alert-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .last-alert {
            color: #888;
            font-size: 9px;
            margin-top: 5px;
        }

        .settings-panel {
            background: #111;
            border: 1px solid #333;
            padding: 15px;
            margin-bottom: 20px;
        }

        .settings-header {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4ade80;
        }

        .settings-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 10px;
        }

        .threshold-group {
            background: #0a0a0a;
            border: 1px solid #222;
            padding: 10px;
        }

        .threshold-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
        }

        .threshold-input {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .threshold-input input {
            width: 60px;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 4px 8px;
            font-family: 'Courier Prime', monospace;
            font-size: 11px;
        }

        .threshold-input input:focus {
            outline: none;
            border-color: #4ade80;
        }

        .threshold-input select {
            flex: 1;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            padding: 4px 8px;
            font-family: 'Courier Prime', monospace;
            font-size: 11px;
        }

        .threshold-input select:focus {
            outline: none;
            border-color: #4ade80;
        }

        .threshold-input label {
            font-size: 10px;
            color: #666;
        }

        @media (max-width: 968px) {
            .settings-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>BINANCE SPOT VS PERPETUAL FUTURES</h1>
        </header>

        <div class="settings-panel">
            <div class="settings-header">ALERT SETTINGS</div>
            <div class="settings-row">
                <div class="threshold-group">
                    <div class="threshold-label">THRESHOLD 1 (STANDARD ALERT)</div>
                    <div class="threshold-input">
                        <label>%</label>
                        <input type="number" id="threshold1" value="2.0" step="0.1" min="0.1">
                        <select id="sound1">
                            <option value="kaching">Ka-Ching (Cash Register)</option>
                            <option value="ding">Ding (Notification)</option>
                            <option value="success">Success (Cheering)</option>
                            <option value="chime">Chime (Pleasant Bell)</option>
                            <option value="coin">Coin (Mario)</option>
                        </select>
                    </div>
                </div>
                <div class="threshold-group">
                    <div class="threshold-label">THRESHOLD 2 (MEGA ALERT)</div>
                    <div class="threshold-input">
                        <label>%</label>
                        <input type="number" id="threshold2" value="5.0" step="0.1" min="0.1">
                        <select id="sound2">
                            <option value="explosion">Explosion (Nuke)</option>
                            <option value="airhorn">Airhorn (MLG)</option>
                            <option value="dramatic">Dramatic (Epic)</option>
                            <option value="alarm">Alarm (Urgent)</option>
                            <option value="wow">WOW! (Reaction)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="status">
            <div class="status-item">
                <span class="status-dot" id="spotStatus"></span>
                <span>BINANCE SPOT: <span id="spotStatusText">CONNECTING</span></span>
            </div>
            <div class="status-item">
                <span class="status-dot" id="perpStatus"></span>
                <span>BINANCE PERP: <span id="perpStatusText">CONNECTING</span></span>
            </div>
            <div class="status-item">
                <span class="status-dot" id="bybitSpotStatus"></span>
                <span>BYBIT SPOT: <span id="bybitSpotStatusText">CONNECTING</span></span>
            </div>
            <div class="status-item">
                <span>BIN PAIRS: <span id="pairsCount">0</span></span>
            </div>
            <div class="status-item">
                <span>BYBIT PAIRS: <span id="bybitPairsCount">0</span></span>
            </div>
        </div>

        <div class="tables-container">
            <!-- Binance Spot vs Binance Perp Section -->
            <div class="binance-section">
                <div class="table-wrapper">
                    <div class="table-header positive">BINANCE: TOP 20 POSITIVE SPREADS (SPOT > PERP)</div>
                    <table>
                        <thead>
                            <tr>
                                <th>SYMBOL</th>
                                <th style="text-align: right;">SPREAD %</th>
                                <th style="text-align: right;">DELTA $</th>
                            </tr>
                        </thead>
                        <tbody id="positiveTable">
                            <tr><td colspan="3" class="loading">LOADING...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="table-wrapper">
                    <div class="table-header negative">BINANCE: TOP 20 NEGATIVE SPREADS (PERP > SPOT)</div>
                    <table>
                        <thead>
                            <tr>
                                <th>SYMBOL</th>
                                <th style="text-align: right;">SPREAD %</th>
                                <th style="text-align: right;">DELTA $</th>
                            </tr>
                        </thead>
                        <tbody id="negativeTable">
                            <tr><td colspan="3" class="loading">LOADING...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="alert-log-wrapper">
                    <div class="table-header" style="color: #fff;">ALERT LOG</div>
                    <div class="alert-log-body" id="alertLogBody">
                        <div style="text-align: center; padding: 20px; color: #666; font-size: 11px;">
                            NO ALERTS YET
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bybit Spot vs Binance Perp Section -->
            <div class="bybit-section">
                <div class="table-wrapper">
                    <div class="table-header positive">BYBIT SPOT - BIN PERPS: TOP 20 POSITIVE (SPOT > PERP)</div>
                    <table>
                        <thead>
                            <tr>
                                <th>SYMBOL</th>
                                <th style="text-align: right;">SPREAD %</th>
                                <th style="text-align: right;">DELTA $</th>
                            </tr>
                        </thead>
                        <tbody id="bybitPositiveTable">
                            <tr><td colspan="3" class="loading">LOADING...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="table-wrapper">
                    <div class="table-header negative">BYBIT SPOT - BIN PERPS: TOP 20 NEGATIVE (PERP > SPOT)</div>
                    <table>
                        <thead>
                            <tr>
                                <th>SYMBOL</th>
                                <th style="text-align: right;">SPREAD %</th>
                                <th style="text-align: right;">DELTA $</th>
                            </tr>
                        </thead>
                        <tbody id="bybitNegativeTable">
                            <tr><td colspan="3" class="loading">LOADING...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="alert-log-wrapper">
                    <div class="table-header" style="color: #fff;">BYBIT ALERT LOG</div>
                    <div class="alert-log-body" id="bybitAlertLogBody">
                        <div style="text-align: center; padding: 20px; color: #666; font-size: 11px;">
                            NO ALERTS YET
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>REAL-TIME DATA VIA BINANCE & BYBIT WEBSOCKET APIS</p>
            <div class="alert-status">
                <span class="alert-indicator"></span>
                <span id="alertStatusText">SOUND ALERTS ACTIVE</span>
            </div>
            <div class="last-alert" id="lastAlertText">NO ALERTS YET</div>
        </footer>
    </div>

    <!-- Audio elements for different sounds -->
    <audio id="audio-kaching" preload="auto" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c1539c.mp3"></audio>
    <audio id="audio-ding" preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c9b25d5d85.mp3"></audio>
    <audio id="audio-success" preload="auto" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_12b0c7443c.mp3"></audio>
    <audio id="audio-chime" preload="auto" src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3"></audio>
    <audio id="audio-coin" preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_4de21017a5.mp3"></audio>
    <audio id="audio-explosion" preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_7e1f72a1a3.mp3"></audio>
    <audio id="audio-airhorn" preload="auto" src="https://cdn.pixabay.com/download/audio/2022/05/23/audio_e5b12025c5.mp3"></audio>
    <audio id="audio-dramatic" preload="auto" src="https://cdn.pixabay.com/download/audio/2022/08/02/audio_a1ab755680.mp3"></audio>
    <audio id="audio-alarm" preload="auto" src="https://cdn.pixabay.com/download/audio/2022/04/27/audio_1ab98f52b4.mp3"></audio>
    <audio id="audio-wow" preload="auto" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_bd0a65d3dc.mp3"></audio>

    <script>
        const spotPrices = new Map();
        const perpPrices = new Map();
        const bybitSpotPrices = new Map();
        let lastUpdateTime = 0;
        const UPDATE_THROTTLE_MS = 300;
        let updateScheduled = false;

        // Track which symbols have triggered alerts (stores threshold level)
        const alertedSymbols = new Map();
        const bybitAlertedSymbols = new Map();

        // Sound cooldown to prevent audio spam
        let lastSoundTime = 0;
        const SOUND_COOLDOWN_MS = 3000; // 3 seconds between sounds

        // Alert log arrays
        const alertLog = [];
        const bybitAlertLog = [];

        // Connect to Binance Spot WebSocket
        function connectSpotWebSocket() {
            const ws = new WebSocket('wss://stream.binance.com:9443/ws/!ticker@arr');

            ws.onopen = () => {
                document.getElementById('spotStatus').className = 'status-dot connected';
                document.getElementById('spotStatusText').textContent = 'CONNECTED';
            };

            ws.onmessage = (event) => {
                try {
                    const tickers = JSON.parse(event.data);
                    for (const ticker of tickers) {
                        if (ticker.s.endsWith('USDT')) {
                            spotPrices.set(ticker.s, {
                                symbol: ticker.s,
                                price: parseFloat(ticker.c),
                            });
                        }
                    }
                    scheduleUpdate();
                } catch (error) {
                    console.error('Error parsing spot data:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('Spot WebSocket error:', error);
                document.getElementById('spotStatus').className = 'status-dot disconnected';
                document.getElementById('spotStatusText').textContent = 'ERROR';
            };

            ws.onclose = () => {
                document.getElementById('spotStatus').className = 'status-dot disconnected';
                document.getElementById('spotStatusText').textContent = 'RECONNECTING';
                setTimeout(connectSpotWebSocket, 5000);
            };
        }

        // Connect to Binance USDM Perpetual Futures WebSocket
        function connectPerpWebSocket() {
            const ws = new WebSocket('wss://fstream.binance.com/ws/!ticker@arr');

            ws.onopen = () => {
                document.getElementById('perpStatus').className = 'status-dot connected';
                document.getElementById('perpStatusText').textContent = 'CONNECTED';
            };

            ws.onmessage = (event) => {
                try {
                    const tickers = JSON.parse(event.data);
                    for (const ticker of tickers) {
                        if (ticker.s.endsWith('USDT')) {
                            perpPrices.set(ticker.s, {
                                symbol: ticker.s,
                                price: parseFloat(ticker.c),
                            });
                        }
                    }
                    scheduleUpdate();
                } catch (error) {
                    console.error('Error parsing perp data:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('Perp WebSocket error:', error);
                document.getElementById('perpStatus').className = 'status-dot disconnected';
                document.getElementById('perpStatusText').textContent = 'ERROR';
            };

            ws.onclose = () => {
                document.getElementById('perpStatus').className = 'status-dot disconnected';
                document.getElementById('perpStatusText').textContent = 'RECONNECTING';
                setTimeout(connectPerpWebSocket, 5000);
            };
        }

        // Fetch Bybit Spot prices via REST API (since WebSocket doesn't support all tickers at once)
        async function fetchBybitSpotPrices() {
            try {
                const response = await fetch('https://api.bybit.com/v5/market/tickers?category=spot');
                const data = await response.json();

                if (data.retCode === 0 && data.result && data.result.list) {
                    document.getElementById('bybitSpotStatus').className = 'status-dot connected';
                    document.getElementById('bybitSpotStatusText').textContent = 'CONNECTED';

                    for (const ticker of data.result.list) {
                        if (ticker.symbol.endsWith('USDT')) {
                            bybitSpotPrices.set(ticker.symbol, {
                                symbol: ticker.symbol,
                                price: parseFloat(ticker.lastPrice),
                            });
                        }
                    }
                    scheduleUpdate();
                } else {
                    throw new Error('Invalid response from Bybit API');
                }
            } catch (error) {
                console.error('Error fetching Bybit spot data:', error);
                document.getElementById('bybitSpotStatus').className = 'status-dot disconnected';
                document.getElementById('bybitSpotStatusText').textContent = 'ERROR';
            }
        }

        // Poll Bybit API every 2 seconds
        function startBybitPolling() {
            fetchBybitSpotPrices(); // Initial fetch
            setInterval(fetchBybitSpotPrices, 2000); // Poll every 2 seconds
        }

        // Throttled update function
        function scheduleUpdate() {
            if (updateScheduled) return;

            const now = Date.now();
            const timeSinceLastUpdate = now - lastUpdateTime;

            if (timeSinceLastUpdate >= UPDATE_THROTTLE_MS) {
                displayDifferences();
                lastUpdateTime = now;
            } else {
                updateScheduled = true;
                setTimeout(() => {
                    updateScheduled = false;
                    displayDifferences();
                    lastUpdateTime = Date.now();
                }, UPDATE_THROTTLE_MS - timeSinceLastUpdate);
            }
        }

        // Play alert sound
        function playAlertSound(soundId) {
            const now = Date.now();
            if (now - lastSoundTime < SOUND_COOLDOWN_MS) return;

            const audio = document.getElementById(`audio-${soundId}`);
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(err => console.log('Audio play failed:', err));
                lastSoundTime = now;
            }
        }

        // Add entry to alert log
        function addAlertLog(symbol, percentDiff, isMega) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();

            alertLog.unshift({
                symbol,
                percent: percentDiff,
                time: timeStr,
                isMega
            });

            // Keep only last 100 alerts
            if (alertLog.length > 100) {
                alertLog.pop();
            }

            updateAlertLogDisplay();
        }

        // Update alert log display
        function updateAlertLogDisplay() {
            const logBody = document.getElementById('alertLogBody');

            if (alertLog.length === 0) {
                logBody.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; font-size: 11px;">NO ALERTS YET</div>';
                return;
            }

            logBody.innerHTML = alertLog.map(entry => `
                <div class="alert-log-entry ${entry.isMega ? 'mega' : 'standard'}">
                    <div>
                        <span class="alert-log-symbol">${entry.symbol}</span>
                        <span class="alert-log-percent"> ${entry.percent.toFixed(2)}%</span>
                        ${entry.isMega ? ' <span style="color: #ef4444; font-size: 10px;">â˜… MEGA</span>' : ''}
                    </div>
                    <div class="alert-log-time">${entry.time}</div>
                </div>
            `).join('');
        }

        // Update Bybit alert log display
        function updateBybitAlertLogDisplay() {
            const logBody = document.getElementById('bybitAlertLogBody');

            if (bybitAlertLog.length === 0) {
                logBody.innerHTML = '<div style="text-align: center; padding: 20px; color: #666; font-size: 11px;">NO ALERTS YET</div>';
                return;
            }

            logBody.innerHTML = bybitAlertLog.map(entry => `
                <div class="alert-log-entry ${entry.isMega ? 'mega' : 'standard'}">
                    <div>
                        <span class="alert-log-symbol">${entry.symbol}</span>
                        <span class="alert-log-percent"> ${entry.percent.toFixed(2)}%</span>
                        ${entry.isMega ? ' <span style="color: #ef4444; font-size: 10px;">â˜… MEGA</span>' : ''}
                    </div>
                    <div class="alert-log-time">${entry.time}</div>
                </div>
            `).join('');
        }

        // Add entry to Bybit alert log
        function addBybitAlertLog(symbol, percentDiff, isMega) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString();

            bybitAlertLog.unshift({
                symbol,
                percent: percentDiff,
                time: timeStr,
                isMega
            });

            // Keep only last 100 alerts
            if (bybitAlertLog.length > 100) {
                bybitAlertLog.pop();
            }

            updateBybitAlertLogDisplay();
        }

        // Calculate and display the differences
        function displayDifferences() {
            const differences = [];

            // Find common symbols
            for (const [symbol, spotData] of spotPrices) {
                if (perpPrices.has(symbol)) {
                    const perpData = perpPrices.get(symbol);
                    const diff = spotData.price - perpData.price;
                    const percentDiff = (diff / perpData.price) * 100;

                    differences.push({
                        symbol,
                        spotPrice: spotData.price,
                        perpPrice: perpData.price,
                        difference: diff,
                        percentDiff,
                    });

                    // Get threshold settings
                    const threshold1 = parseFloat(document.getElementById('threshold1').value) || 2.0;
                    const threshold2 = parseFloat(document.getElementById('threshold2').value) || 5.0;
                    const sound1 = document.getElementById('sound1').value;
                    const sound2 = document.getElementById('sound2').value;

                    // Check thresholds (higher threshold takes precedence)
                    const currentLevel = alertedSymbols.get(symbol) || 0;

                    if (percentDiff >= threshold2 && currentLevel < 2) {
                        alertedSymbols.set(symbol, 2);
                        playAlertSound(sound2);
                        addAlertLog(symbol, percentDiff, true);
                        console.log(`ðŸš¨ MEGA ALERT: ${symbol} spread at ${percentDiff.toFixed(2)}%`);

                        // Update last alert text
                        const now = new Date();
                        const timeStr = now.toLocaleTimeString();
                        document.getElementById('lastAlertText').textContent =
                            `MEGA ALERT: ${symbol} @ ${percentDiff.toFixed(2)}% - ${timeStr}`;
                    } else if (percentDiff >= threshold1 && currentLevel < 1) {
                        alertedSymbols.set(symbol, 1);
                        playAlertSound(sound1);
                        addAlertLog(symbol, percentDiff, false);
                        console.log(`ðŸ”” ALERT: ${symbol} spread at ${percentDiff.toFixed(2)}%`);

                        // Update last alert text
                        const now = new Date();
                        const timeStr = now.toLocaleTimeString();
                        document.getElementById('lastAlertText').textContent =
                            `ALERT: ${symbol} @ ${percentDiff.toFixed(2)}% - ${timeStr}`;
                    }

                    // Reset threshold tracking if spread drops significantly
                    const resetThreshold = Math.min(threshold1, threshold2) * 0.75;
                    if (percentDiff < resetThreshold) {
                        alertedSymbols.delete(symbol);
                    }
                }
            }

            // Update pairs count
            document.getElementById('pairsCount').textContent = differences.length;

            // Separate positive and negative spreads
            const positiveSpreads = differences
                .filter(d => d.percentDiff > 0)
                .sort((a, b) => b.percentDiff - a.percentDiff)
                .slice(0, 20);

            const negativeSpreads = differences
                .filter(d => d.percentDiff < 0)
                .sort((a, b) => a.percentDiff - b.percentDiff)
                .slice(0, 20);

            // Update positive spreads table
            const positiveTable = document.getElementById('positiveTable');
            positiveTable.innerHTML = positiveSpreads.length > 0
                ? positiveSpreads.map(item => `
                    <tr>
                        <td class="symbol">${item.symbol}</td>
                        <td class="spread-positive">+${item.percentDiff.toFixed(2)}%</td>
                        <td class="delta">$${Math.abs(item.difference).toFixed(4)}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="3" class="loading">NO DATA</td></tr>';

            // Update negative spreads table
            const negativeTable = document.getElementById('negativeTable');
            negativeTable.innerHTML = negativeSpreads.length > 0
                ? negativeSpreads.map(item => `
                    <tr>
                        <td class="symbol">${item.symbol}</td>
                        <td class="spread-negative">${item.percentDiff.toFixed(2)}%</td>
                        <td class="delta">$${Math.abs(item.difference).toFixed(4)}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="3" class="loading">NO DATA</td></tr>';

            // Calculate Bybit Spot vs Binance Perp differences
            // Only include symbols that are NOT in Binance Spot (to show unique Bybit pairs)
            const bybitDifferences = [];

            // Find common symbols (Bybit spot vs Binance perp)
            for (const [symbol, perpData] of perpPrices) {
                // Skip if this symbol is already in Binance Spot
                if (spotPrices.has(symbol)) {
                    continue;
                }

                if (bybitSpotPrices.has(symbol)) {
                    const bybitSpotData = bybitSpotPrices.get(symbol);
                    const diff = bybitSpotData.price - perpData.price;
                    const percentDiff = (diff / perpData.price) * 100;

                    bybitDifferences.push({
                        symbol,
                        perpPrice: perpData.price,
                        bybitSpotPrice: bybitSpotData.price,
                        difference: diff,
                        percentDiff,
                    });

                    // Get threshold settings
                    const threshold1 = parseFloat(document.getElementById('threshold1').value) || 2.0;
                    const threshold2 = parseFloat(document.getElementById('threshold2').value) || 5.0;
                    const sound1 = document.getElementById('sound1').value;
                    const sound2 = document.getElementById('sound2').value;

                    // Check thresholds (higher threshold takes precedence)
                    const currentLevel = bybitAlertedSymbols.get(symbol) || 0;

                    if (percentDiff >= threshold2 && currentLevel < 2) {
                        bybitAlertedSymbols.set(symbol, 2);
                        playAlertSound(sound2);
                        addBybitAlertLog(symbol, percentDiff, true);
                        console.log(`ðŸš¨ BYBIT MEGA ALERT: ${symbol} spread at ${percentDiff.toFixed(2)}%`);
                    } else if (percentDiff >= threshold1 && currentLevel < 1) {
                        bybitAlertedSymbols.set(symbol, 1);
                        playAlertSound(sound1);
                        addBybitAlertLog(symbol, percentDiff, false);
                        console.log(`ðŸ”” BYBIT ALERT: ${symbol} spread at ${percentDiff.toFixed(2)}%`);
                    }

                    // Reset threshold tracking if spread drops significantly
                    const resetThreshold = Math.min(threshold1, threshold2) * 0.75;
                    if (percentDiff < resetThreshold) {
                        bybitAlertedSymbols.delete(symbol);
                    }
                }
            }

            // Update Bybit pairs count
            document.getElementById('bybitPairsCount').textContent = bybitDifferences.length;

            // Separate positive and negative spreads for Bybit comparison
            const bybitPositiveSpreads = bybitDifferences
                .filter(d => d.percentDiff > 0)
                .sort((a, b) => b.percentDiff - a.percentDiff)
                .slice(0, 20);

            const bybitNegativeSpreads = bybitDifferences
                .filter(d => d.percentDiff < 0)
                .sort((a, b) => a.percentDiff - b.percentDiff)
                .slice(0, 20);

            // Update Bybit positive spreads table (Perp > Spot)
            const bybitPositiveTable = document.getElementById('bybitPositiveTable');
            bybitPositiveTable.innerHTML = bybitPositiveSpreads.length > 0
                ? bybitPositiveSpreads.map(item => `
                    <tr>
                        <td class="symbol">${item.symbol}</td>
                        <td class="spread-positive">+${item.percentDiff.toFixed(2)}%</td>
                        <td class="delta">$${Math.abs(item.difference).toFixed(4)}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="3" class="loading">NO DATA</td></tr>';

            // Update Bybit negative spreads table (Spot > Perp)
            const bybitNegativeTable = document.getElementById('bybitNegativeTable');
            bybitNegativeTable.innerHTML = bybitNegativeSpreads.length > 0
                ? bybitNegativeSpreads.map(item => `
                    <tr>
                        <td class="symbol">${item.symbol}</td>
                        <td class="spread-negative">${item.percentDiff.toFixed(2)}%</td>
                        <td class="delta">$${Math.abs(item.difference).toFixed(4)}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="3" class="loading">NO DATA</td></tr>';
        }

        // Update alert status text based on settings
        function updateAlertStatus() {
            const threshold1 = parseFloat(document.getElementById('threshold1').value) || 2.0;
            const threshold2 = parseFloat(document.getElementById('threshold2').value) || 5.0;
            document.getElementById('alertStatusText').textContent =
                `SOUND ALERTS ACTIVE (${threshold1}% / ${threshold2}%)`;
        }

        // Add event listeners to threshold inputs
        document.getElementById('threshold1').addEventListener('input', updateAlertStatus);
        document.getElementById('threshold2').addEventListener('input', updateAlertStatus);

        // Initialize connections
        connectSpotWebSocket();
        connectPerpWebSocket();
        startBybitPolling();

        // Set initial alert status text
        updateAlertStatus();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Binance Spot vs Perpetual Futures</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier Prime', 'Courier New', monospace;
            background: #000;
            color: #fff;
            padding: 10px;
            min-height: 100vh;
            font-size: 12px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        h1 {
            font-size: 16px;
            font-weight: normal;
            margin-bottom: 5px;
        }

        .status {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 11px;
            flex-wrap: wrap;
        }

        .status-item {
            background: #111;
            padding: 5px 10px;
            border: 1px solid #333;
        }

        .status-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-dot.connected {
            background: #00ff00;
        }

        .status-dot.disconnected {
            background: #ff0000;
        }

        .tables-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 968px) {
            .tables-container {
                grid-template-columns: 1fr;
            }
        }

        .table-wrapper {
            background: #111;
            border: 1px solid #333;
            padding: 10px;
        }

        .table-header {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #333;
        }

        .table-header.positive {
            color: #4ade80;
        }

        .table-header.negative {
            color: #ef4444;
        }

        table {
            border-collapse: collapse;
            table-layout: fixed;
        }

        thead th {
            text-align: left;
            padding: 5px;
            font-weight: bold;
            border-bottom: 1px solid #333;
            font-size: 11px;
            color: #888;
        }

        thead th:nth-child(1) {
            width: 150px;
        }

        thead th:nth-child(2) {
            width: 90px;
        }

        thead th:nth-child(3) {
            width: 100px;
        }

        tbody tr {
            transition: background 0.1s;
        }

        tbody tr:hover {
            background: #1a1a1a;
        }

        tbody td {
            padding: 4px 5px;
            border-bottom: 1px solid #222;
            font-size: 11px;
        }

        .symbol {
            font-weight: normal;
            color: #ddd;
        }

        .spread-positive {
            color: #4ade80;
            text-align: right;
        }

        .spread-negative {
            color: #ef4444;
            text-align: right;
        }

        .delta {
            text-align: right;
            color: #999;
            font-size: 10px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 11px;
            color: #666;
        }

        footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #333;
            font-size: 10px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>BINANCE SPOT VS PERPETUAL FUTURES</h1>
        </header>

        <div class="status">
            <div class="status-item">
                <span class="status-dot" id="spotStatus"></span>
                <span>SPOT: <span id="spotStatusText">CONNECTING</span></span>
            </div>
            <div class="status-item">
                <span class="status-dot" id="perpStatus"></span>
                <span>PERP: <span id="perpStatusText">CONNECTING</span></span>
            </div>
            <div class="status-item">
                <span>PAIRS: <span id="pairsCount">0</span></span>
            </div>
        </div>

        <div class="tables-container">
            <div class="table-wrapper">
                <div class="table-header positive">TOP 20 POSITIVE SPREADS (SPOT > PERP)</div>
                <table>
                    <thead>
                        <tr>
                            <th>SYMBOL</th>
                            <th style="text-align: right;">SPREAD %</th>
                            <th style="text-align: right;">DELTA $</th>
                        </tr>
                    </thead>
                    <tbody id="positiveTable">
                        <tr><td colspan="3" class="loading">LOADING...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="table-wrapper">
                <div class="table-header negative">TOP 20 NEGATIVE SPREADS (PERP > SPOT)</div>
                <table>
                    <thead>
                        <tr>
                            <th>SYMBOL</th>
                            <th style="text-align: right;">SPREAD %</th>
                            <th style="text-align: right;">DELTA $</th>
                        </tr>
                    </thead>
                    <tbody id="negativeTable">
                        <tr><td colspan="3" class="loading">LOADING...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <footer>
            <p>REAL-TIME DATA VIA BINANCE WEBSOCKET API</p>
        </footer>
    </div>

    <!-- Audio element for ka-ching sound -->
    <audio id="kachingSound" preload="auto">
        <source src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c1539c.mp3" type="audio/mpeg">
    </audio>

    <script>
        const spotPrices = new Map();
        const perpPrices = new Map();
        let lastUpdateTime = 0;
        const UPDATE_THROTTLE_MS = 300;
        let updateScheduled = false;

        // Track which symbols have triggered the alert to avoid spam
        const alertedSymbols = new Set();

        // Sound cooldown to prevent audio spam
        let lastSoundTime = 0;
        const SOUND_COOLDOWN_MS = 3000; // 3 seconds between sounds

        // Connect to Binance Spot WebSocket
        function connectSpotWebSocket() {
            const ws = new WebSocket('wss://stream.binance.com:9443/ws/!ticker@arr');

            ws.onopen = () => {
                document.getElementById('spotStatus').className = 'status-dot connected';
                document.getElementById('spotStatusText').textContent = 'CONNECTED';
            };

            ws.onmessage = (event) => {
                try {
                    const tickers = JSON.parse(event.data);
                    for (const ticker of tickers) {
                        if (ticker.s.endsWith('USDT')) {
                            spotPrices.set(ticker.s, {
                                symbol: ticker.s,
                                price: parseFloat(ticker.c),
                            });
                        }
                    }
                    scheduleUpdate();
                } catch (error) {
                    console.error('Error parsing spot data:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('Spot WebSocket error:', error);
                document.getElementById('spotStatus').className = 'status-dot disconnected';
                document.getElementById('spotStatusText').textContent = 'ERROR';
            };

            ws.onclose = () => {
                document.getElementById('spotStatus').className = 'status-dot disconnected';
                document.getElementById('spotStatusText').textContent = 'RECONNECTING';
                setTimeout(connectSpotWebSocket, 5000);
            };
        }

        // Connect to Binance USDM Perpetual Futures WebSocket
        function connectPerpWebSocket() {
            const ws = new WebSocket('wss://fstream.binance.com/ws/!ticker@arr');

            ws.onopen = () => {
                document.getElementById('perpStatus').className = 'status-dot connected';
                document.getElementById('perpStatusText').textContent = 'CONNECTED';
            };

            ws.onmessage = (event) => {
                try {
                    const tickers = JSON.parse(event.data);
                    for (const ticker of tickers) {
                        if (ticker.s.endsWith('USDT')) {
                            perpPrices.set(ticker.s, {
                                symbol: ticker.s,
                                price: parseFloat(ticker.c),
                            });
                        }
                    }
                    scheduleUpdate();
                } catch (error) {
                    console.error('Error parsing perp data:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('Perp WebSocket error:', error);
                document.getElementById('perpStatus').className = 'status-dot disconnected';
                document.getElementById('perpStatusText').textContent = 'ERROR';
            };

            ws.onclose = () => {
                document.getElementById('perpStatus').className = 'status-dot disconnected';
                document.getElementById('perpStatusText').textContent = 'RECONNECTING';
                setTimeout(connectPerpWebSocket, 5000);
            };
        }

        // Throttled update function
        function scheduleUpdate() {
            if (updateScheduled) return;

            const now = Date.now();
            const timeSinceLastUpdate = now - lastUpdateTime;

            if (timeSinceLastUpdate >= UPDATE_THROTTLE_MS) {
                displayDifferences();
                lastUpdateTime = now;
            } else {
                updateScheduled = true;
                setTimeout(() => {
                    updateScheduled = false;
                    displayDifferences();
                    lastUpdateTime = Date.now();
                }, UPDATE_THROTTLE_MS - timeSinceLastUpdate);
            }
        }

        // Play ka-ching sound
        function playKachingSound() {
            const now = Date.now();
            if (now - lastSoundTime < SOUND_COOLDOWN_MS) return;

            const audio = document.getElementById('kachingSound');
            audio.currentTime = 0;
            audio.play().catch(err => console.log('Audio play failed:', err));
            lastSoundTime = now;
        }

        // Calculate and display the differences
        function displayDifferences() {
            const differences = [];

            // Find common symbols
            for (const [symbol, spotData] of spotPrices) {
                if (perpPrices.has(symbol)) {
                    const perpData = perpPrices.get(symbol);
                    const diff = spotData.price - perpData.price;
                    const percentDiff = (diff / perpData.price) * 100;

                    differences.push({
                        symbol,
                        spotPrice: spotData.price,
                        perpPrice: perpData.price,
                        difference: diff,
                        percentDiff,
                    });

                    // Check if spot is 2% or more above perp
                    if (percentDiff >= 2.0 && !alertedSymbols.has(symbol)) {
                        alertedSymbols.add(symbol);
                        playKachingSound();
                        console.log(`ðŸ”” ALERT: ${symbol} spread at ${percentDiff.toFixed(2)}%`);
                    }

                    // Remove from alerted set if spread drops below 1.5% (reset threshold)
                    if (percentDiff < 1.5) {
                        alertedSymbols.delete(symbol);
                    }
                }
            }

            // Update pairs count
            document.getElementById('pairsCount').textContent = differences.length;

            // Separate positive and negative spreads
            const positiveSpreads = differences
                .filter(d => d.percentDiff > 0)
                .sort((a, b) => b.percentDiff - a.percentDiff)
                .slice(0, 20);

            const negativeSpreads = differences
                .filter(d => d.percentDiff < 0)
                .sort((a, b) => a.percentDiff - b.percentDiff)
                .slice(0, 20);

            // Update positive spreads table
            const positiveTable = document.getElementById('positiveTable');
            positiveTable.innerHTML = positiveSpreads.length > 0
                ? positiveSpreads.map(item => `
                    <tr>
                        <td class="symbol">${item.symbol}</td>
                        <td class="spread-positive">+${item.percentDiff.toFixed(2)}%</td>
                        <td class="delta">$${Math.abs(item.difference).toFixed(4)}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="3" class="loading">NO DATA</td></tr>';

            // Update negative spreads table
            const negativeTable = document.getElementById('negativeTable');
            negativeTable.innerHTML = negativeSpreads.length > 0
                ? negativeSpreads.map(item => `
                    <tr>
                        <td class="symbol">${item.symbol}</td>
                        <td class="spread-negative">${item.percentDiff.toFixed(2)}%</td>
                        <td class="delta">$${Math.abs(item.difference).toFixed(4)}</td>
                    </tr>
                `).join('')
                : '<tr><td colspan="3" class="loading">NO DATA</td></tr>';
        }

        // Initialize connections
        connectSpotWebSocket();
        connectPerpWebSocket();
    </script>
</body>
</html>
